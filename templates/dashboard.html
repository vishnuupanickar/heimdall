<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heimdall - Network Status</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="wrap">
    <header class="header">
      <img class="brand-logo" src="{{ url_for('static', filename='logo.png') }}" alt="Heimdall logo" />
      <p class="subtitle">Currently monitoring: <code id="targetCode">{{ target }}</code></p>
      <p class="subtitle">Access URL (any device on the same network): <code>http://{{ lan_ip }}:{{ flask_port }}</code></p>
    </header>

    <section class="status-card">
      <div class="status-badge" id="statusBadge" aria-live="polite">
        <span class="status-dot" id="statusDot"></span>
        <span class="status-label" id="statusLabel">Checking...</span>
      </div>
      <p class="last-check" id="lastCheck">-</p>
      <div class="uptime-bar" aria-hidden="true">
        <div class="uptime-fill" id="uptimeFill" style="width: 0%"></div>
      </div>
      <p class="uptime-pct" id="uptimePct">-</p>
    </section>

    <section class="stats-grid">
      <div class="stat">
        <span class="stat-value" id="samples">-</span>
        <span class="stat-label">Samples (24h)</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="downtimeSec">-</span>
        <span class="stat-label">Downtime (24h)</span>
      </div>
    </section>

    <section class="downtimes-section">
      <h2 class="section-title">Recent downtime</h2>
      <div class="downtimes-list" id="downtimesList">
        <p class="empty" id="downtimesEmpty">No recorded downtime.</p>
      </div>
    </section>

    <section class="settings-section">
      <h2 class="section-title">Settings</h2>
      <form class="settings-form" id="settingsForm">
        <label>
          Ping target
          <input id="cfgTarget" name="ping_target" type="text" required />
        </label>
        <label>
          Poll interval (seconds)
          <input id="cfgInterval" name="poll_interval" type="number" min="1" max="3600" required />
        </label>
        <label>
          Ping timeout (seconds)
          <input id="cfgTimeout" name="ping_timeout" type="number" min="1" max="60" required />
        </label>
        <button type="submit" id="cfgSaveBtn">Save settings</button>
      </form>
      <p class="settings-msg" id="settingsMsg" aria-live="polite"></p>
    </section>
  </div>

  <script>
    const statusBadge = document.getElementById('statusBadge');
    const statusDot = document.getElementById('statusDot');
    const statusLabel = document.getElementById('statusLabel');
    const lastCheckEl = document.getElementById('lastCheck');
    const uptimeFill = document.getElementById('uptimeFill');
    const uptimePct = document.getElementById('uptimePct');
    const samplesEl = document.getElementById('samples');
    const downtimeSecEl = document.getElementById('downtimeSec');
    const downtimesList = document.getElementById('downtimesList');
    const downtimesEmpty = document.getElementById('downtimesEmpty');
    const targetCode = document.getElementById('targetCode');
    const settingsForm = document.getElementById('settingsForm');
    const cfgTarget = document.getElementById('cfgTarget');
    const cfgInterval = document.getElementById('cfgInterval');
    const cfgTimeout = document.getElementById('cfgTimeout');
    const cfgSaveBtn = document.getElementById('cfgSaveBtn');
    const settingsMsg = document.getElementById('settingsMsg');

    function formatTime(ts) {
      if (ts == null) return '-';
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    function formatDuration(sec) {
      if (sec == null || sec === 0) return '0s';
      if (sec < 60) return sec + 's';
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      if (m < 60) return m + 'm ' + s + 's';
      const h = Math.floor(m / 60);
      const mm = m % 60;
      return h + 'h ' + mm + 'm ' + s + 's';
    }

    async function fetchJson(path) {
      const r = await fetch(path);
      let body = null;
      try {
        body = await r.json();
      } catch (e) {
        body = null;
      }
      if (!r.ok) {
        const msg = body && body.error ? body.error : r.statusText;
        throw new Error(msg);
      }
      return body;
    }

    async function postJson(path, payload) {
      const r = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      let body = null;
      try {
        body = await r.json();
      } catch (e) {
        body = null;
      }
      if (!r.ok) {
        const msg = body && body.error ? body.error : r.statusText;
        throw new Error(msg);
      }
      return body;
    }

    function renderStatus(data) {
      const up = data.up;
      statusBadge.className = 'status-badge ' + (up === true ? 'up' : up === false ? 'down' : 'unknown');
      statusDot.setAttribute('aria-label', up === true ? 'Up' : up === false ? 'Down' : 'Unknown');
      statusLabel.textContent = up === true ? 'Up' : up === false ? 'Down' : 'Checking...';
      lastCheckEl.textContent = data.last_check ? 'Last check: ' + formatTime(data.last_check) : '-';
    }

    function renderStats(data) {
      if (data.uptime_pct != null) {
        uptimeFill.style.width = data.uptime_pct + '%';
        uptimePct.textContent = data.uptime_pct + '% uptime (24h)';
      }
      samplesEl.textContent = data.samples ?? '-';
      downtimeSecEl.textContent = data.downtime_seconds != null ? formatDuration(data.downtime_seconds) : '-';
    }

    function renderDowntimes(list) {
      if (!list || list.length === 0) {
        downtimesEmpty.hidden = false;
        downtimesList.querySelectorAll('.downtime-item').forEach(el => el.remove());
        return;
      }
      downtimesEmpty.hidden = true;
      const fragment = document.createDocumentFragment();
      list.forEach(d => {
        const start = formatTime(d.started_at);
        const end = formatTime(d.ended_at);
        const duration = d.ended_at != null ? formatDuration(Math.round(d.ended_at - d.started_at)) : 'ongoing';
        const div = document.createElement('div');
        div.className = 'downtime-item';
        div.innerHTML = '<span class="downtime-time">' + start + ' -> ' + end + '</span> <span class="downtime-dur">' + duration + '</span>';
        fragment.appendChild(div);
      });
      downtimesList.querySelectorAll('.downtime-item').forEach(el => el.remove());
      downtimesList.insertBefore(fragment, downtimesEmpty);
    }

    function renderConfig(cfg) {
      cfgTarget.value = cfg.ping_target ?? '';
      cfgInterval.value = cfg.poll_interval ?? 10;
      cfgTimeout.value = cfg.ping_timeout ?? 5;
      targetCode.textContent = cfg.ping_target ?? targetCode.textContent;
    }

    function setSettingsMessage(msg, isError = false) {
      settingsMsg.textContent = msg;
      settingsMsg.className = 'settings-msg ' + (isError ? 'error' : 'ok');
    }

    async function loadConfig() {
      try {
        const cfg = await fetchJson('/api/config');
        renderConfig(cfg);
      } catch (e) {
        setSettingsMessage('Could not load settings: ' + e.message, true);
      }
    }

    async function refresh() {
      try {
        const [status, stats, downtimes] = await Promise.all([
          fetchJson('/api/status'),
          fetchJson('/api/stats'),
          fetchJson('/api/downtimes')
        ]);
        renderStatus(status);
        renderStats(stats);
        renderDowntimes(downtimes.downtimes);
      } catch (e) {
        statusBadge.className = 'status-badge unknown';
        statusLabel.textContent = 'Offline / error';
        lastCheckEl.textContent = 'Could not reach server.';
      }
    }

    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      cfgSaveBtn.disabled = true;
      setSettingsMessage('Saving...');
      try {
        const payload = {
          ping_target: cfgTarget.value.trim(),
          poll_interval: Number(cfgInterval.value),
          ping_timeout: Number(cfgTimeout.value)
        };
        const cfg = await postJson('/api/config', payload);
        renderConfig(cfg);
        setSettingsMessage('Settings saved.');
      } catch (err) {
        setSettingsMessage('Save failed: ' + err.message, true);
      } finally {
        cfgSaveBtn.disabled = false;
      }
    });

    loadConfig();
    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>
